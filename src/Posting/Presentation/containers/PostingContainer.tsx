import React, { useState, useEffect } from 'react';
import { Post } from '../../Domain/entities/Post';
import { PostCard } from '../components/PostCard';
import { PostStats } from '../components/PostStats';
import { LocalStoragePostRepository } from '../../Infrastructure/repositories/LocalStoragePostRepository';
import { PostType, POST_TYPE_LABELS } from '../../Domain/value-objects/PostType';
import { DateTimeFormatter } from '../../../Shared/infrastructure/utils/DateTimeFormatter';


export const PostingContainer: React.FC = () => {
  const [loading, setLoading] = useState(true);
  const [posts, setPosts] = useState<Post[]>([]);
  const [filteredPosts, setFilteredPosts] = useState<Post[]>([]);
  const [selectedFilter, setSelectedFilter] = useState('all');
  const [editingPost, setEditingPost] = useState<Post | null>(null);
  const [showEditForm, setShowEditForm] = useState(false);
  const [showCreateForm, setShowCreateForm] = useState(false);
  const [removingPostIds, setRemovingPostIds] = useState<Set<string>>(new Set()); // –î–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏ —É–¥–∞–ª–µ–Ω–∏—è
  const [newPostIds, setNewPostIds] = useState<Set<string>>(new Set()); // –î–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏ –ø–æ—è–≤–ª–µ–Ω–∏—è

  const repository = new LocalStoragePostRepository();

  useEffect(() => {
    loadPosts();
    initializeSampleData();
  }, []);

  useEffect(() => {
    applyFilter(posts, selectedFilter);
  }, [posts, selectedFilter]);

  const initializeSampleData = async () => {
    try {
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ –¥–∞–Ω–Ω—ã–µ –≤ localStorage
      const existingPosts = await repository.findAll();
      if (existingPosts.isSuccess && existingPosts.value.length > 0) {
        return;
      }
      const response = await fetch('/src/Posting/Infrastructure/data/samplePosts.json');
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }

      const rawPosts = await response.json();
      
      // –°–æ–∑–¥–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –ø–æ—Å—Ç—ã —Å —Ä–∞–∑–Ω—ã–º–∏ –∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏ –¥–ª—è –¥–µ–º–æ
      const uniquePosts = [
        {
          ...rawPosts[0],
          id: 'demo-1',
          title: 'üåô –õ—É–Ω–Ω–æ–µ –∑–∞—Ç–º–µ–Ω–∏–µ - –¥–µ–∫–∞–±—Ä—å 2024',
          status: 'draft'
        },
        {
          ...rawPosts[1],
          id: 'demo-2', 
          title: 'üìà BTC –∞–Ω–∞–ª–∏–∑ - –±—ã—á–∏–π —Ç—Ä–µ–Ω–¥',
          status: 'scheduled'
        },
        {
          ...rawPosts[2],
          id: 'demo-3',
          title: 'üå† –ú–µ—Ç–µ–æ—Ä–Ω—ã–π –ø–æ—Ç–æ–∫ –ö–≤–∞–¥—Ä–∞–Ω—Ç–∏–¥—ã',
          status: 'draft'
        },
        {
          id: 'demo-4',
          title: '‚òÄÔ∏è –°–æ–ª–Ω–µ—á–Ω–æ–µ –∑–∞—Ç–º–µ–Ω–∏–µ - –∞–ø—Ä–µ–ª—å 2025',
          content: '–ö–æ–ª—å—Ü–µ–æ–±—Ä–∞–∑–Ω–æ–µ —Å–æ–ª–Ω–µ—á–Ω–æ–µ –∑–∞—Ç–º–µ–Ω–∏–µ –±—É–¥–µ—Ç –Ω–∞–±–ª—é–¥–∞—Ç—å—Å—è –≤ —Å–µ–≤–µ—Ä–Ω—ã—Ö —Ä–µ–≥–∏–æ–Ω–∞—Ö.\n\nüìÖ 8 –∞–ø—Ä–µ–ª—è 2025\n‚≠ê –ü—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: 4 –º–∏–Ω—É—Ç—ã\n\n#—Å–æ–ª–Ω—Ü–µ #–∑–∞—Ç–º–µ–Ω–∏–µ #–∞—Å—Ç—Ä–æ–Ω–æ–º–∏—è',
          status: 'published',
          type: 'astronomical_update',
          scheduledAt: new Date('2025-04-07T15:00:00.000Z'),
          metadata: {
            template: 'astronomical_event',
            variables: {},
            tags: ['–∞—Å—Ç—Ä–æ–Ω–æ–º–∏—è', '—Å–æ–ª–Ω—Ü–µ'],
            priority: 'high'
          },
          authorId: 'admin',
          publishedAt: new Date('2025-04-07T15:05:00.000Z')
        },
        {
          id: 'demo-5',
          title: 'üí∞ ETH –ø—Ä–æ–≥–Ω–æ–∑ –Ω–∞ –Ω–µ–¥–µ–ª—é',
          content: 'Ethereum –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∫–æ–Ω—Å–æ–ª–∏–¥–∞—Ü–∏—é –≤ –¥–∏–∞–ø–∞–∑–æ–Ω–µ $2800-$3200.\n\nüéØ –¶–µ–ª–∏: $3400 –ø—Ä–∏ –ø—Ä–æ–±–æ–µ –≤–≤–µ—Ä—Ö\nüõ°Ô∏è –°—Ç–æ–ø: $2650\n\nüåü –ê—Å—Ç—Ä–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Ñ–∞–∫—Ç–æ—Ä: –ü–æ–ª–Ω–æ–ª—É–Ω–∏–µ –≤ –ë–ª–∏–∑–Ω–µ—Ü–∞—Ö –º–æ–∂–µ—Ç –¥–∞—Ç—å –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å.\n\n#ethereum #–ø—Ä–æ–≥–Ω–æ–∑ #–∫—Ä–∏–ø—Ç–æ–∞–Ω–∞–ª–∏–∑',
          status: 'scheduled',
          type: 'market_analysis', 
          scheduledAt: new Date('2024-12-28T10:00:00.000Z'),
          metadata: {
            template: 'market_analysis',
            variables: {
              symbol: 'ETH/USD',
              trend: 'sideways'
            },
            tags: ['ethereum', '–∞–Ω–∞–ª–∏–∑'],
            priority: 'medium'
          },
          authorId: 'admin'
        }
      ];

      for (const postData of uniquePosts) {
        const post = new Post(
          postData.id,
          postData.title,
          postData.content,
          postData.status,
          postData.type,
          new Date(postData.scheduledAt),
          postData.metadata || {},
          postData.authorId || 'admin',
          postData.publishedAt ? new Date(postData.publishedAt) : undefined,
          postData.images || [],
          postData.telegramMessageId
        );
        await repository.save(post);
      }
      
      await loadPosts();
    } catch (error) {
      // –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ sample –¥–∞–Ω–Ω—ã—Ö
    }
  };

  const loadPosts = async () => {
    try {
      setLoading(true);
      const result = await repository.findAll();

      if (result.isSuccess) {
        setPosts(result.value);
        applyFilter(result.value, selectedFilter);
      }
    } catch (error) {
      // –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ—Å—Ç–æ–≤
    } finally {
      setLoading(false);
    }
  };

  const applyFilter = (postsToFilter: Post[], filter: string) => {
    if (filter === 'all') {
      setFilteredPosts(postsToFilter);
    } else {
      const filtered = postsToFilter.filter(post => post.status === filter);
      setFilteredPosts(filtered);
    }
  };

  const handleFilterChange = (filter: string) => {
    setSelectedFilter(filter);
    setRemovingPostIds(new Set()); // –û—á–∏—â–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏–∏ –ø—Ä–∏ —Å–º–µ–Ω–µ —Ñ–∏–ª—å—Ç—Ä–∞
    setNewPostIds(new Set());
    applyFilter(posts, filter);
  };

  const handleCreatePost = async (postData: any) => {
    try {
      const post = new Post(
        crypto.randomUUID(),
        postData.title,
        postData.content,
        'draft', // New posts start as draft
        postData.type,
        new Date(postData.scheduledAt),
        {
          template: 'default',
          variables: {},
          tags: [],
          priority: postData.priority || 'medium'
        },
        'admin',
        undefined,
        postData.images || []
      );

      const result = await repository.save(post);

      if (result.isSuccess) {
        setShowCreateForm(false);
        await loadPosts();
        
        // –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ –≤ Telegram
        if (postData.sendToTelegram) {
          // –ò–Ω–∏—Ü–∏–∏—Ä—É–µ–º –æ—Ç–ø—Ä–∞–≤–∫—É –≤ Telegram
          // –ò—Å–ø–æ–ª—å–∑—É–µ–º TelegramBotService –Ω–∞–ø—Ä—è–º—É—é –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ—Å—Ç–∞
          const { TelegramBotBrowserService } = await import('../../Infrastructure/services/TelegramBotBrowserService');
          
          try {
            const telegramConfig = {
              token: import.meta.env.VITE_TELEGRAM_BOT_TOKEN || '',
              chatId: import.meta.env.VITE_TELEGRAM_CHAT_ID || ''
            };

            if (telegramConfig.token && telegramConfig.chatId) {
              const telegramService = new TelegramBotBrowserService(telegramConfig);
              const telegramResult = await telegramService.sendPost(post);
              
              if (telegramResult.success && telegramResult.messageId) {
                // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ—Å—Ç —Å messageId
                await handleTelegramSent(post.id, telegramResult.messageId);
              }
            }
          } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ Telegram:', error);
          }
        }
      } else {
        alert(`–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è: ${result.error}`);
      }
    } catch (error) {
      alert(`–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è: ${error}`);
    }
  };

  const handleUpdatePost = async (updatedData: any) => {
    try {
      if (!editingPost) {
        return;
      }

      // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –æ–±—ä–µ–∫—Ç –ø–æ—Å—Ç–∞ —Å –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
      const updatedPost = new Post(
        editingPost.id,
        updatedData.title,
        updatedData.content,
        editingPost.status,
        updatedData.type,
        editingPost.scheduledAt,
        updatedData.metadata || editingPost.metadata,
        editingPost.authorId,
        editingPost.publishedAt,
        editingPost.images,
        editingPost.telegramMessageId
      );

      const result = await repository.save(updatedPost);

      if (result.isSuccess) {
        setShowEditForm(false);
        setEditingPost(null);
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤–º–µ—Å—Ç–æ –ø–æ–ª–Ω–æ–π –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏
        const updatedPosts = posts.map(p => p.id === updatedPost.id ? updatedPost : p);
        setPosts(updatedPosts);
        applyFilter(updatedPosts, selectedFilter);
        
      } else {
        alert(`–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è: ${result.error}`);
      }
    } catch (error) {
      alert(`–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è: ${error}`);
    }
  };

  const handleEdit = (id: string) => {
    const postToEdit = posts.find(p => p.id === id);
    if (postToEdit) {
      setEditingPost(postToEdit);
      setShowEditForm(true);
    }
  };

  const handleDelete = async (id: string) => {
    const postToDelete = posts.find(p => p.id === id);

    if (!postToDelete) {
      return;
    }

    const confirmed = window.confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –ø–æ—Å—Ç "${postToDelete.title}"?`);

    if (!confirmed) {
      return;
    }

    try {
      // –°–Ω–∞—á–∞–ª–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é —É–¥–∞–ª–µ–Ω–∏—è
      setRemovingPostIds(new Set([id]));
      
      const result = await repository.delete(id);

      if (result.isSuccess) {
        const postsAfterDelete = await repository.findAll();

        if (postsAfterDelete.isSuccess) {
          const updatedPosts = postsAfterDelete.value;
          
          // –ß–µ—Ä–µ–∑ 300ms –æ–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–∫–∏ (–ø–æ—Å–ª–µ –∞–Ω–∏–º–∞—Ü–∏–∏)
          setTimeout(() => {
            setPosts(updatedPosts);
            applyFilter(updatedPosts, selectedFilter);
            setRemovingPostIds(new Set());
          }, 300);
        } else {
          // Fallback: –æ–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ
          const updatedPosts = posts.filter(p => p.id !== id);
          
          setTimeout(() => {
            setPosts(updatedPosts);
            applyFilter(updatedPosts, selectedFilter);
            setRemovingPostIds(new Set());
          }, 300);
        }
      } else {
        // –ï—Å–ª–∏ —É–¥–∞–ª–µ–Ω–∏–µ –Ω–µ —É–¥–∞–ª–æ—Å—å, —É–±–∏—Ä–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é
        setRemovingPostIds(new Set());
        alert(`–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ${result.error}`);
      }
    } catch (error) {
      // –ï—Å–ª–∏ –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞, —É–±–∏—Ä–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é
      setRemovingPostIds(new Set());
      alert(`–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ${error}`);
    }
  };



  const handleCancelEdit = () => {
    setShowEditForm(false);
    setEditingPost(null);
  };

  const handleCancelCreate = () => {
    setShowCreateForm(false);
  };

  const handleShowCreateForm = () => {
    setShowCreateForm(true);
  };

  const handleTelegramSent = async (postId: string, messageId: number) => {
    try {
      const postToUpdate = posts.find(p => p.id === postId);
      if (!postToUpdate) return;

      // –°–æ–∑–¥–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π –ø–æ—Å—Ç —Å telegramMessageId –∏ —Å—Ç–∞—Ç—É—Å–æ–º "scheduled"
      const updatedPost = new Post(
        postToUpdate.id,
        postToUpdate.title,
        postToUpdate.content,
        'scheduled', // –ü–µ—Ä–µ–≤–æ–¥–∏–º –≤ —Å—Ç–∞—Ç—É—Å "scheduled" –ø–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ Telegram
        postToUpdate.type,
        postToUpdate.scheduledAt,
        postToUpdate.metadata,
        postToUpdate.authorId,
        postToUpdate.publishedAt,
        postToUpdate.images,
        messageId.toString()
      );

      const result = await repository.save(updatedPost);

      if (result.isSuccess) {
        // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        const updatedPosts = posts.map(p => p.id === postId ? updatedPost : p);
        setPosts(updatedPosts);
        applyFilter(updatedPosts, selectedFilter);
      }
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è messageId:', error);
    }
  };

  const handleClearAllPosts = async () => {
    const confirmed = window.confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –í–°–ï –ø–æ—Å—Ç—ã? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å!');
    
    if (!confirmed) {
      return;
    }

    try {
      // –û—á–∏—â–∞–µ–º localStorage
      localStorage.removeItem('astrobit_posts');
      
      // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
      setPosts([]);
      setFilteredPosts([]);
      
      // –í—Å–µ –ø–æ—Å—Ç—ã —É–¥–∞–ª–µ–Ω—ã
      
      // –ó–∞–≥—Ä—É–∂–∞–µ–º fresh sample –¥–∞–Ω–Ω—ã–µ
      await initializeSampleData();
      
    } catch (error) {
      alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ –¥–∞–Ω–Ω—ã—Ö');
    }
  };

  if (loading) {
    return <div className="flex justify-center p-8">–ó–∞–≥—Ä—É–∑–∫–∞...</div>;
  }

  return (
    <div className="p-8 bg-gray-50 min-h-screen">
      <div className="max-w-[1600px] mx-auto w-full">
        <h1 className="text-3xl font-bold text-gray-800 mb-8">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω–∞—è –ø–∞–Ω–µ–ª—å AstroBit</h1>

      <div className="mb-6 w-full">
        <PostStats posts={posts} selectedFilter={selectedFilter} onFilterChange={handleFilterChange} />
      </div>

      <div className="mb-6 py-4">
        <div className="flex gap-2">
          <button
            onClick={handleShowCreateForm}
            className="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700"
          >
            ‚ûï –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –ø–æ—Å—Ç
          </button>
          <button
            onClick={handleClearAllPosts}
            className="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700"
          >
            üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ
          </button>
        </div>
      </div>

      {showCreateForm && (
        <div className="bg-gray-800 rounded-lg shadow-md p-6 mb-6 border border-gray-700">
          <h2 className="text-xl font-semibold mb-4 text-white">–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –ø–æ—Å—Ç</h2>
          <form onSubmit={(e) => {
            e.preventDefault();
            const formData = new FormData(e.target as HTMLFormElement);
            handleCreatePost({
              title: formData.get('title'),
              content: formData.get('content'),
              type: formData.get('type'),
              scheduledAt: formData.get('scheduledAt'),
              priority: formData.get('priority'),
              sendToTelegram: formData.get('sendToTelegram') === 'on'
            });
          }}>
            <div className="grid grid-cols-2 gap-4 mb-4">
              <input
                name="title"
                placeholder="–ó–∞–≥–æ–ª–æ–≤–æ–∫ –ø–æ—Å—Ç–∞"
                className="border border-gray-600 rounded-lg px-3 py-2 bg-gray-100 text-gray-900 placeholder-gray-500 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                required
              />
              <select name="type" className="border border-gray-600 rounded-lg px-3 py-2 bg-gray-100 text-gray-900 focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
                <option value="">–¢–∏–ø –ø–æ—Å—Ç–∞</option>
                {Object.values(PostType).map(type => (
                  <option key={type} value={type}>{POST_TYPE_LABELS[type as PostType]}</option>
                ))}
              </select>
            </div>
            <textarea
              name="content"
              placeholder="–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –ø–æ—Å—Ç–∞"
              className="w-full border border-gray-600 rounded-lg px-3 py-2 mb-4 bg-gray-100 text-gray-900 placeholder-gray-500 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              rows={4}
              required
            />
            <div className="grid grid-cols-2 gap-4 mb-4">
              <input
                name="scheduledAt"
                type="datetime-local"
                className="border border-gray-600 rounded-lg px-3 py-2 bg-gray-100 text-gray-900 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                defaultValue={new Date().toISOString().slice(0, 16)}
                required
              />
              <select name="priority" className="border border-gray-600 rounded-lg px-3 py-2 bg-gray-100 text-gray-900 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                <option value="low">–ù–∏–∑–∫–∏–π</option>
                <option value="medium">–°—Ä–µ–¥–Ω–∏–π</option>
                <option value="high">–í—ã—Å–æ–∫–∏–π</option>
              </select>
            </div>
            <div className="mb-4">
              <label className="flex items-center gap-2">
                <input
                  name="sendToTelegram"
                  type="checkbox"
                  className="rounded bg-gray-100 border-gray-600 text-blue-600 focus:ring-blue-500"
                />
                <span className="text-sm text-gray-300">üì§ –°—Ä–∞–∑—É –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ Telegram</span>
              </label>
            </div>
            <div className="flex gap-2">
              <button
                type="submit"
                className="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700"
              >
                –°–æ–∑–¥–∞—Ç—å
              </button>
              <button
                type="button"
                onClick={handleCancelCreate}
                className="bg-gray-400 text-white px-4 py-2 rounded-lg hover:bg-gray-500"
              >
                –û—Ç–º–µ–Ω–∞
              </button>
            </div>
          </form>
        </div>
      )}

      {showEditForm && editingPost && (
        <div className="bg-gray-800 rounded-lg shadow-md p-6 mb-6 border border-gray-700">
          <h2 className="text-xl font-semibold mb-4 text-white">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ—Å—Ç</h2>
          <form onSubmit={(e) => {
            e.preventDefault();
            const formData = new FormData(e.target as HTMLFormElement);
            handleUpdatePost({
              title: formData.get('title'),
              content: formData.get('content'),
              type: formData.get('type'),
              scheduledAt: formData.get('scheduledAt'),
              priority: formData.get('priority')
            });
          }}>
            <div className="grid grid-cols-2 gap-4 mb-4">
              <input
                name="title"
                placeholder="–ó–∞–≥–æ–ª–æ–≤–æ–∫ –ø–æ—Å—Ç–∞"
                className="border border-gray-600 rounded-lg px-3 py-2 bg-gray-100 text-gray-900 placeholder-gray-500 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                defaultValue={editingPost.title}
                required
              />
              <select name="type" className="border border-gray-600 rounded-lg px-3 py-2 bg-gray-100 text-gray-900 focus:ring-2 focus:ring-blue-500 focus:border-transparent" required defaultValue={editingPost.type}>
                <option value="">–¢–∏–ø –ø–æ—Å—Ç–∞</option>
                {Object.values(PostType).map(type => (
                  <option key={type} value={type}>{POST_TYPE_LABELS[type as PostType]}</option>
                ))}
              </select>
            </div>
            <textarea
              name="content"
              placeholder="–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –ø–æ—Å—Ç–∞"
              className="w-full border border-gray-600 rounded-lg px-3 py-2 mb-4 bg-gray-100 text-gray-900 placeholder-gray-500 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              rows={4}
              defaultValue={editingPost.content}
              required
            />
            <div className="grid grid-cols-2 gap-4 mb-4">
              <input
                name="scheduledAt"
                type="datetime-local"
                className="border border-gray-600 rounded-lg px-3 py-2 bg-gray-100 text-gray-900 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                defaultValue={DateTimeFormatter.formatForDateTimeInput(editingPost.scheduledAt)}
                required
              />
              <select name="priority" className="border border-gray-600 rounded-lg px-3 py-2 bg-gray-100 text-gray-900 focus:ring-2 focus:ring-blue-500 focus:border-transparent" defaultValue={editingPost.metadata.priority}>
                <option value="low">–ù–∏–∑–∫–∏–π</option>
                <option value="medium">–°—Ä–µ–¥–Ω–∏–π</option>
                <option value="high">–í—ã—Å–æ–∫–∏–π</option>
              </select>
            </div>
            <div className="flex gap-2">
              <button
                type="submit"
                className="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700"
              >
                –û–±–Ω–æ–≤–∏—Ç—å
              </button>
              <button
                type="button"
                onClick={handleCancelEdit}
                className="bg-gray-400 text-white px-4 py-2 rounded-lg hover:bg-gray-500"
              >
                –û—Ç–º–µ–Ω–∞
              </button>
            </div>
          </form>
        </div>
      )}

      <div className="mb-4 flex justify-between items-center">
        <h2 className="text-2xl font-semibold text-gray-800">–°–ø–∏—Å–æ–∫ –ø–æ—Å—Ç–æ–≤</h2>
      </div>

      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {filteredPosts.map((post, index) => (
          <div
            key={post.id || `post-${index}`}
            className={`transition-all duration-300 ease-in-out hover:scale-105 ${
              removingPostIds.has(post.id) 
                ? 'opacity-0 scale-75 transform translate-y-4 rotate-1' 
                : newPostIds.has(post.id)
                ? 'opacity-0 scale-50 transform -translate-y-8'
                : 'opacity-100 scale-100 transform translate-y-0 rotate-0'
            }`}
          >
            <PostCard
              post={post}
              onEdit={handleEdit}
              onDelete={handleDelete}
              onTelegramSent={handleTelegramSent}
            />
          </div>
        ))}
      </div>
      </div>
    </div>
  );
};
