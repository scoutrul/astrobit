# Архив: Планирование системы автоматического постинга AstroBit

## Метаданные
- **Дата создания:** 25.08.2025
- **Режим:** PLAN Mode
- **Уровень сложности:** Level 3 (Intermediate Feature)
- **Статус:** Планирование завершено

## Обзор системы

### Цель проекта
Создать внутреннюю систему для планирования, утверждения и автоматической публикации постов в Telegram-канале AstroBit. Система должна обеспечивать своевременный выход контента, минимизировать ручной труд и генерировать структурированные сообщения на основе астрологических событий и рыночных данных.

### Ключевые возможности
1. **Планирование публикаций** - создание и редактирование постов заранее
2. **Автоматическая генерация** - черновики на основе астрономических и рыночных событий
3. **Управление контентом** - workflow от черновика до публикации
4. **Автоматическая публикация** - по расписанию без участия человека
5. **Интеграция данных** - астрономические события + рыночные данные

## Архитектурный план

### Новые модули системы

#### 1. Posting Module (Основной модуль)
```
src/Posting/
├── Domain/
│   ├── entities/
│   │   ├── Post.ts
│   │   ├── PostTemplate.ts
│   │   └── PostSchedule.ts
│   ├── value-objects/
│   │   ├── PostStatus.ts
│   │   ├── PostType.ts
│   │   └── PostContent.ts
│   └── repositories/
│       └── IPostRepository.ts
├── Application/
│   ├── use-cases/
│   │   ├── CreatePostUseCase.ts
│   │   ├── UpdatePostUseCase.ts
│   │   ├── SchedulePostUseCase.ts
│   │   ├── PublishPostUseCase.ts
│   │   └── GeneratePostContentUseCase.ts
│   └── services/
│       └── PostContentService.ts
├── Infrastructure/
│   ├── repositories/
│   │   └── JsonFilePostRepository.ts
│   ├── services/
│   │   ├── TelegramBotService.ts
│   │   ├── PostSchedulerService.ts
│   │   └── ImageStorageService.ts
│   └── data/
│       ├── posts.json
│       ├── templates.json
│       └── schedules.json
└── Presentation/
    ├── components/
    │   ├── PostEditor.tsx
    │   ├── PostScheduler.tsx
    │   ├── PostHistory.tsx
    │   └── AdminPanel.tsx
    ├── containers/
    │   └── PostingContainer.tsx
    └── hooks/
        └── usePosting.ts
```

#### 2. Scheduler Module (Планировщик)
```
src/Scheduler/
├── Domain/
│   ├── entities/
│   │   └── ScheduledTask.ts
│   └── services/
│       └── ISchedulerService.ts
├── Infrastructure/
│   ├── services/
│   │   ├── CronSchedulerService.ts
│   │   └── TaskQueueService.ts
│   └── data/
│       └── scheduled-tasks.json
└── Application/
    └── use-cases/
        ├── ScheduleTaskUseCase.ts
        └── ExecuteTaskUseCase.ts
```

#### 3. Content Generator Module (Генератор контента)
```
src/ContentGenerator/
├── Domain/
│   ├── entities/
│   │   ├── ContentTemplate.ts
│   │   └── ContentRule.ts
│   └── services/
│       └── IContentGeneratorService.ts
├── Application/
│   ├── use-cases/
│   │   ├── GenerateAstronomicalPostUseCase.ts
│   │   ├── GenerateMarketAnalysisPostUseCase.ts
│   │   └── GenerateWeeklyReviewUseCase.ts
│   └── services/
│       ├── TemplateEngineService.ts
│       └── ContentRuleEngineService.ts
└── Infrastructure/
    ├── services/
    │   ├── MarkdownTemplateService.ts
│   │   └── ContentVariableResolver.ts
    └── templates/
        ├── astronomical-events.md
        ├── market-analysis.md
        └── weekly-review.md
```

### Интеграция с существующими модулями

#### Astronomical Module
- **Использование:** Получение астрономических событий для генерации контента
- **Интеграция:** Через существующие Use Cases и Repository
- **Данные:** Лунные фазы, затмения, планетарные соединения, метеорные потоки

#### CryptoData Module
- **Использование:** Получение рыночных данных для анализа
- **Интеграция:** Через существующие Use Cases
- **Данные:** Цены криптовалют, объемы торгов, технические индикаторы

#### Charting Module
- **Использование:** Генерация скриншотов графиков для постов
- **Интеграция:** Через существующие компоненты
- **Функционал:** Экспорт графиков в изображения, настройка временных рамок

#### Shared Module
- **Использование:** Общие утилиты, аутентификация, логирование
- **Интеграция:** Через существующие сервисы
- **Компоненты:** BaseEntity, Result, DomainError, аутентификация

## Структура данных

### Основные сущности

#### Post (Пост)
```typescript
interface Post {
  id: string;
  title: string;
  content: string;
  status: PostStatus;
  type: PostType;
  scheduledAt: Date;
  publishedAt?: Date;
  createdAt: Date;
  updatedAt: Date;
  authorId: string;
  images?: string[];
  metadata: PostMetadata;
  telegramMessageId?: string;
}

interface PostMetadata {
  astronomicalEvents?: string[];
  marketData?: MarketDataSnapshot;
  template: string;
  variables: Record<string, any>;
  tags: string[];
  priority: 'low' | 'medium' | 'high';
}

interface MarketDataSnapshot {
  timestamp: Date;
  symbols: Record<string, {
    price: number;
    change24h: number;
    volume24h: number;
  }>;
  marketCap: number;
  fearGreedIndex?: number;
}
```

#### PostTemplate (Шаблон поста)
```typescript
interface PostTemplate {
  id: string;
  name: string;
  description: string;
  type: PostType;
  content: string;
  variables: TemplateVariable[];
  isActive: boolean;
  createdAt: Date;
  updatedAt: Date;
}

interface TemplateVariable {
  name: string;
  type: 'string' | 'number' | 'date' | 'array' | 'object';
  description: string;
  required: boolean;
  defaultValue?: any;
  validation?: ValidationRule;
}
```

#### ScheduledTask (Запланированная задача)
```typescript
interface ScheduledTask {
  id: string;
  postId: string;
  type: 'publish' | 'generate' | 'reminder';
  scheduledAt: Date;
  status: 'pending' | 'running' | 'completed' | 'failed';
  retryCount: number;
  maxRetries: number;
  lastRunAt?: Date;
  nextRunAt: Date;
  cronExpression?: string;
  metadata: Record<string, any>;
}
```

### Enums и типы

#### PostStatus
```typescript
enum PostStatus {
  DRAFT = 'draft',           // Черновик
  APPROVED = 'approved',     // Утверждено
  SCHEDULED = 'scheduled',   // Запланировано
  PUBLISHING = 'publishing', // Публикуется
  PUBLISHED = 'published',   // Опубликовано
  FAILED = 'failed',         // Ошибка публикации
  CANCELLED = 'cancelled'    // Отменено
}
```

#### PostType
```typescript
enum PostType {
  ANNOUNCEMENT = 'announcement',     // Анонс
  EVENT_ANALYSIS = 'event_analysis', // Анализ события
  MARKET_ANALYSIS = 'market_analysis', // Анализ рынка
  WEEKLY_REVIEW = 'weekly_review',   // Обзор недели
  MONTHLY_REVIEW = 'monthly_review', // Обзор месяца
  ASTRONOMICAL_UPDATE = 'astronomical_update', // Астрономическое обновление
  TRADING_SIGNAL = 'trading_signal'  // Торговый сигнал
}
```

## План реализации

### Фаза 1: Базовая инфраструктура (2-3 недели)
1. **Создание Posting Module структуры**
   - Создание базовых сущностей и интерфейсов
   - Настройка TypeScript конфигурации
   - Создание базовых Use Cases

2. **Настройка Telegram Bot API**
   - Создание бота через @BotFather
   - Настройка webhook или polling
   - Базовая интеграция с API

3. **Создание JSON хранилища**
   - Структура файлов данных
   - Базовые CRUD операции
   - Валидация данных

4. **Базовая аутентификация**
   - Простая система логин/пароль
   - Middleware для защищенных маршрутов
   - Сессии администратора

### Фаза 2: Основной функционал (3-4 недели)
1. **CRUD операции для постов**
   - Создание, чтение, обновление, удаление
   - Валидация бизнес-правил
   - Обработка ошибок

2. **Система статусов и workflow**
   - Переходы между статусами
   - Бизнес-логика для каждого статуса
   - Аудит изменений

3. **Планировщик публикаций**
   - Интеграция с node-cron
   - Очередь задач
   - Обработка ошибок и повторные попытки

4. **Базовый UI для управления**
   - Список постов
   - Форма создания/редактирования
   - Просмотр статусов

### Фаза 3: Автоматизация (4-5 недель)
1. **Генератор контента на основе событий**
   - Шаблоны для разных типов постов
   - Подстановка переменных
   - Валидация сгенерированного контента

2. **Интеграция с астрономическими данными**
   - Получение событий из Astronomical Module
   - Анализ влияния на рынок
   - Генерация контекста

3. **Интеграция с рыночными данными**
   - Получение данных из CryptoData Module
   - Технический анализ
   - Формирование выводов

4. **Автоматическая публикация**
   - Отправка в Telegram
   - Обработка ошибок
   - Логирование результатов

### Фаза 4: Расширенный функционал (3-4 недели)
1. **Шаблоны постов**
   - Редактор шаблонов
   - Предварительный просмотр
   - Управление версиями

2. **Поддержка изображений**
   - Загрузка изображений
   - Генерация скриншотов графиков
   - Оптимизация и сжатие

3. **Аналитика и отчеты**
   - Статистика публикаций
   - Анализ эффективности
   - Экспорт данных

4. **Тестирование и оптимизация**
   - Unit тесты
   - Integration тесты
   - Performance оптимизация

## Технологический стек

### Основные технологии
- **Frontend:** React 19.1.0 + TypeScript 5.8.3 (существующий)
- **Backend:** Node.js + TypeScript
- **Build System:** Vite 6.0.1 (существующий)
- **Styling:** Tailwind CSS 3.4.4 (существующий)

### Новые зависимости
```json
{
  "node-telegram-bot-api": "^0.64.0",
  "node-cron": "^3.0.3",
  "multer": "^1.4.5-lts.1",
  "sharp": "^0.33.0",
  "moment": "^2.29.4",
  "lodash": "^4.17.21"
}
```

### Архитектурные паттерны
- **Clean Architecture** - разделение на слои
- **Repository Pattern** - абстракция данных
- **Use Case Pattern** - бизнес-операции
- **Observer Pattern** - планировщик задач
- **Template Method** - генерация контента

## Вызовы и решения

### Основные вызовы

#### 1. Интеграция с Telegram API
**Вызов:** Обеспечение надежной доставки сообщений
**Решение:** 
- Использование официальной библиотеки node-telegram-bot-api
- Webhook для production, polling для development
- Обработка ошибок и повторные попытки
- Логирование всех операций

#### 2. Планировщик задач
**Вызов:** Надежное выполнение задач по расписанию
**Решение:**
- Использование node-cron для cron-подобного планирования
- Очередь задач с приоритизацией
- Обработка ошибок и повторные попытки
- Мониторинг выполнения задач

#### 3. Хранение изображений
**Вызов:** Эффективное хранение и обработка изображений
**Решение:**
- Локальное хранение с структурированной организацией
- Sharp для оптимизации и сжатия
- Автоматическая очистка неиспользуемых файлов
- Backup стратегия

#### 4. Аутентификация и безопасность
**Вызов:** Защита административного интерфейса
**Решение:**
- Простая система логин/пароль для начала
- JWT токены для сессий
- Rate limiting для API
- Логирование всех действий администратора

### Стратегии решения

#### 1. Модульная архитектура
- Следование существующей Clean Architecture
- Четкое разделение ответственности
- Легкая тестируемость компонентов
- Возможность независимой разработки модулей

#### 2. Постепенная интеграция
- Поэтапное добавление функционала
- Тестирование каждого этапа
- Возможность отката изменений
- Минимальное влияние на существующий код

#### 3. Тестирование
- Unit тесты для критических компонентов
- Integration тесты для API
- E2E тесты для основных сценариев
- Автоматизированное тестирование

#### 4. Документация
- Подробная документация API
- Пользовательские сценарии
- Архитектурная документация
- Руководства по развертыванию

## Компоненты, требующие Creative Phase

### 🎨 UI/UX Design
1. **Админ-панель управления постами**
   - Дашборд с обзором всех постов
   - Фильтры и поиск
   - Статистика и метрики

2. **Интерфейс планирования публикаций**
   - Календарь публикаций
   - Drag & Drop планирование
   - Настройка времени и дат

3. **Просмотр истории и архива**
   - Хронологический список
   - Группировка по типам
   - Экспорт данных

4. **Формы создания и редактирования постов**
   - Rich text редактор
   - Предварительный просмотр
   - Валидация в реальном времени

### 🏗️ Architecture Design
1. **Архитектура Posting Module**
   - Структура модуля
   - Взаимодействие между слоями
   - Интеграция с существующими модулями

2. **Система планировщика**
   - Архитектура планировщика
   - Очередь задач
   - Обработка ошибок

3. **Структура данных и хранилище**
   - Организация JSON файлов
   - Схемы валидации
   - Стратегия backup

### ⚙️ Algorithm Design
1. **Алгоритм генерации контента**
   - Логика подстановки переменных
   - Обработка условных блоков
   - Валидация результата

2. **Логика планировщика публикаций**
   - Приоритизация задач
   - Обработка конфликтов времени
   - Оптимизация расписания

3. **Система шаблонов и макросов**
   - Парсинг шаблонов
   - Обработка макросов
   - Кэширование шаблонов

4. **Интеграция астрономических и рыночных данных**
   - Корреляционный анализ
   - Временные паттерны
   - Генерация выводов

## Метрики успеха

### Функциональные метрики
- [ ] 100% автоматическая публикация по расписанию
- [ ] Генерация контента для всех типов астрономических событий
- [ ] Интеграция с 100% существующих модулей
- [ ] Поддержка всех требуемых типов постов

### Технические метрики
- [ ] Время отклика UI < 200ms
- [ ] Время публикации поста < 5 секунд
- [ ] Доступность системы > 99.5%
- [ ] Время восстановления после сбоя < 1 минуты

### Пользовательские метрики
- [ ] Время создания поста < 2 минут
- [ ] Время планирования публикации < 1 минуты
- [ ] Удобство использования (UX score > 8/10)
- [ ] Полнота автоматизации > 90%

## Риски и митигация

### Технические риски
1. **Риск:** Проблемы с Telegram API
   **Митигация:** Fallback механизмы, мониторинг, альтернативные каналы

2. **Риск:** Проблемы с планировщиком
   **Митигация:** Redundancy, health checks, автоматическое восстановление

3. **Риск:** Проблемы с производительностью
   **Митигация:** Профилирование, оптимизация, масштабирование

### Бизнес риски
1. **Риск:** Недостаточная автоматизация
   **Митигация:** Поэтапное развитие, обратная связь пользователей

2. **Риск:** Сложность использования
   **Митигация:** UX исследования, итеративный дизайн, тестирование

## Заключение

Система автоматического постинга AstroBit представляет собой комплексное решение Level 3 сложности, требующее тщательного планирования архитектуры и дизайна компонентов. 

### Ключевые преимущества планируемого решения:
1. **Полная автоматизация** процесса публикации
2. **Интеграция** с существующей архитектурой проекта
3. **Масштабируемость** и расширяемость
4. **Надежность** и отказоустойчивость
5. **Удобство использования** для администраторов

### Следующие шаги:
1. **CREATIVE MODE** - дизайн UI/UX и архитектурных решений
2. **IMPLEMENT MODE** - поэтапная реализация системы
3. **VAN QA MODE** - валидация и тестирование
4. **REFLECT MODE** - анализ результатов и оптимизация

Планирование завершено успешно. Система готова к переходу в Creative Phase для детального дизайна компонентов.
